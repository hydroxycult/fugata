services:
  - type: web
    name: fugata-backend
    runtime: rust
    plan: starter
    region: oregon
    branch: main
    rootDir: backend
    
    buildCommand: cargo build --release
    startCommand: ./target/release/fugata
    
    # Run migrations before deploy
    preDeployCommand: |
      cargo install sqlx-cli --no-default-features --features postgres
      sqlx migrate run
    
    # Health check
    healthCheckPath: /healthz
    
    # Graceful shutdown
    maxShutdownDelaySeconds: 30
    
    envVars:
      # ===== PUBLIC CONFIGURATION =====
      - key: RUST_LOG
        value: info
      
      - key: ENVIRONMENT
        value: production
      
      - key: PORT
        value: 10000
      
      # Rate limiting
      - key: RATE_LIMIT_RPM
        value: 60
      
      - key: RATE_LIMIT_BURST
        value: 10
      
      # Proxy configuration (Render uses load balancer)
      - key: PROXY_MODE
        value: TrustedProxy
      
      - key: TRUSTED_PROXIES
        value: 10.0.0.0/8
      
      # Secret size limits
      - key: MAX_SECRET_SIZE
        value: 10485760
      
      # Cache settings
      - key: LRU_CACHE_SIZE
        value: 1000
      
      # Database pool
      - key: DB_MAX_CONNECTIONS
        value: 25
      
      - key: DB_QUERY_TIMEOUT_SECS
        value: 30
      
      # TTL presets
      - key: TTL_PRESETS
        value: 5m,1h,24h,7d,30d
      
      # Worker configuration
      - key: ARGON2_TIME
        value: 2
      
      - key: ARGON2_MEMORY
        value: 19456
      
      - key: ARGON2_PARALLELISM
        value: 1
      
      - key: HASHER_WORKER_COUNT
        value: 4
      
      - key: HASHER_QUEUE_SIZE
        value: 100
      
      # KMS configuration
      - key: KMS_PROVIDER
        value: Local
      
      - key: KMS_FAIL_CLOSED
        value: "true"
      
      - key: DELETION_TOKEN_EXPIRY_HOURS
        value: 24
      
      - key: TOKEN_REPLAY_TTL_HOURS
        value: 1
      
      # ===== SECRETS (prompt during setup) =====
      
      # Database (auto-provided by Render)
      - key: DATABASE_URL
        fromDatabase:
          name: fugata-db
          property: connectionString
      
      # CORS allowed origins (includes localhost for development)
      - key: ALLOWED_ORIGINS
        value: http://localhost:5173,http://localhost:3000
      
      # Encryption keys
      - key: IP_HASH_KEY
        generateValue: true
      
      - key: PEPPER
        generateValue: true
      
      - key: KMS_LOCAL_KEY
        generateValue: true

databases:
  - name: fugata-db
    databaseName: fugata_production
    plan: starter
    region: oregon
